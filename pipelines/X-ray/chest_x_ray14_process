import ast
import PIL
import os

def main_chest_xray_14(source_dir, result_dir):
    target_path = os.path.join(result_dir, "Chest_X-ray14")
    if not os.path.exists(os.path.join(target_path)):
        os.makedirs(target_path)
    # labels of dataset
    names = ["Healthy", "Atelectasis" , "Cardiomegaly", "Effusion", "Infiltration", "Mass", "Nodule", "Pneumonia", "Pneumothorax", "Consolidation", "Edema", "Emphysema", "Fibrosis", "Pleural_Thickening", "Hernia"]
    dir_s = source_dir          # path to source images
    dir_d = target_path          # destination path for images
    dir_labels = target_path+'/labels.csv'     # path to .csv file with labels

    for i in range(0, 12):
        if (i!=0):
            source1 = dir_s + '/images ' + str(i) + '/'
        else:
            source1 = dir_s + '/images' + '/'

        with open(dir_labels) as infile:
            lines = infile.readlines()[1:]
            # open file for each line in .csv file and process it
            for line in lines:
                f_name = line[:16]
                print(f_name)
                # open file
                try:
                    image = PIL.Image.open(source1 + f_name)
                    # extract diseases names from image description
                    labels = ast.literal_eval(line[17:])
                    labels = ast.literal_eval(labels)
                    diseases = [i for i in range(len(labels)) if labels[i] == 1]

                    n_name = f_name[:12]    # image identifier
                    # add diseases to file name
                    for d in diseases:
                        n_name += ('-' + names[d])
                    n_name += '.png'
                    # save with new name
                    image.save((dir_d + '/' + n_name), format="png")
                except IOError:
                    print('')



